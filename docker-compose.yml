services:
  minio:
    image: coollabsio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./docker/init-minio.sh:/init-minio.sh
    entrypoint: "/init-minio.sh"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_DEFAULT_BUCKETS: default

  db:
    image: postgres:15.4
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: ${PGPASSWORD}
      POSTGRES_USER: ${PGUSER:-postgres}
      POSTGRES_DB: ${PGDATABASE:-postgres}
    volumes:
      - db-data:/var/lib/postgresql/data

  lightdash:
    platform: linux/amd64
    image: lightdash/lightdash:latest
    depends_on:
      - db
      - minio
    environment:
      # Контейнер Lightdash подключается к Postgres по имени сервиса «db», не по localhost
      PGHOST: db
      PGPORT: ${PGPORT:-5432}
      PGUSER: ${PGUSER:-postgres}
      PGPASSWORD: ${PGPASSWORD}
      PGDATABASE: ${PGDATABASE:-postgres}
      SECURE_COOKIES: ${SECURE_COOKIES:-false}
      TRUST_PROXY: ${TRUST_PROXY:-false}
      LIGHTDASH_SECRET: ${LIGHTDASH_SECRET}
      PORT: ${PORT:-8080}
      LIGHTDASH_LOG_LEVEL: ${LIGHTDASH_LOG_LEVEL:-info}
      LIGHTDASH_INSTALL_ID: ${LIGHTDASH_INSTALL_ID:-}
      LIGHTDASH_INSTALL_TYPE: ${LIGHTDASH_INSTALL_TYPE:-docker_image}
      LIGHTDASH_LICENSE_KEY: ${LIGHTDASH_LICENSE_KEY:-}
      SITE_URL: ${SITE_URL:-http://localhost:8080}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-default}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
    volumes:
      - ${DBT_PROJECT_DIR}:/usr/app/dbt
    ports:
      - "${PORT:-8080}:${PORT:-8080}"

volumes:
  db-data:
